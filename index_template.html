<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Musings Index</title>
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
        max-width: 1000px;
        margin: 2rem auto;
        padding: 0 1rem;
    }
    h1 {
        text-align: center;
    }
    .controls {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .search-box input {
        padding: 0.5rem;
        width: 200px;
        font-size: 1rem;
    }
    .tag-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    .tag-button {
        padding: 0.3rem 0.6rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: #f5f5f5;
        cursor: pointer;
        font-size: 0.9rem;
        user-select: none;
        white-space: nowrap;
        transition: background-color 0.2s ease, color 0.2s ease;
    }
    .tag-button.active {
        background: #007acc;
        color: white;
        border-color: #007acc;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th {
        text-align: left;
        border-bottom: 2px solid #ccc;
        padding: 0.5rem;
        user-select: none;
        white-space: nowrap;
        vertical-align: middle;
    }
    /* Updated widths */
    th.title-col {
        width: 50%;
    }
    th.year-col {
        width: 10%;
    }
    th.authors-col {
        width: 20%;
    }
    th.tags-col {
        width: 20%;
    }
    td {
        padding: 0.5rem;
        vertical-align: top;
        overflow-wrap: break-word;
    }
    a {
        color: #007acc;
        text-decoration: none;
    }
    a:hover {
        text-decoration: underline;
    }
    .sort-button {
        font-size: 0.9rem;
        margin-left: 0.3rem;
        cursor: pointer;
        color: #666;
        user-select: none;
        vertical-align: middle;
        display: inline-block;
        width: 1.2em;
        text-align: center;
    }
    .sort-button:hover {
        color: #000;
    }
    .sort-button.asc::after {
        content: "▲";
        font-size: 0.7rem;
        margin-left: 0.2em;
    }
    .sort-button.desc::after {
        content: "▼";
        font-size: 0.7rem;
        margin-left: 0.2em;
    }
</style>
</head>
<body>
<h1>Musings</h1>

<div class="controls">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search papers..." aria-label="Search papers" />
    </div>
</div>

<div class="tag-buttons" role="list">
    {% for tag in all_tags %}
    <button class="tag-button" data-tag="{{ tag }}" type="button">{{ tag }}</button>
    {% endfor %}
</div>

<table id="papersTable" aria-label="List of papers">
    <thead>
        <tr>
            <th class="title-col">
                Title
                <span class="sort-button asc" data-sort="title" role="button" aria-pressed="true" tabindex="0" title="Sort by Title"></span>
            </th>
            <th class="year-col">
                Year
                <span class="sort-button" data-sort="year" role="button" aria-pressed="false" tabindex="0" title="Sort by Year"></span>
            </th>
            <th class="authors-col">Authors</th>
            <th class="tags-col">Tags</th>
        </tr>
    </thead>
    <tbody id="papersTbody">
        {% for paper in papers %}
        <tr data-title="{{ paper.title | lower }}" data-year="{{ paper.year | int(default=0) }}" data-tags="{{ paper.tags | join(',') }}">
            <td><a href="papers/{{ paper.filename }}">{{ paper.title }}</a></td>
            <td>{{ paper.year }}</td>
            <td>{{ paper.authors }}</td>
            <td>
                {% for tag in paper.tags %}
                <span>{{ tag }}</span>{% if not loop.last %}, {% endif %}
                {% endfor %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    const searchInput = document.getElementById("searchInput");
    const tagButtons = document.querySelectorAll(".tag-button");
    const tbody = document.getElementById("papersTbody");
    const sortButtons = document.querySelectorAll(".sort-button");

    let activeTag = null;
    let sortState = {
        title: "asc",
        year: null
    };

    function updateSortButtonUI() {
        sortButtons.forEach(btn => {
            const key = btn.dataset.sort;
            if (sortState[key]) {
                btn.classList.add(sortState[key]);
                btn.classList.remove(sortState[key] === 'asc' ? 'desc' : 'asc');
                btn.setAttribute("aria-pressed", "true");
            } else {
                btn.classList.remove("asc", "desc");
                btn.setAttribute("aria-pressed", "false");
            }
        });
    }

    function filterAndSortRows() {
        const query = searchInput.value.toLowerCase();
        const rows = Array.from(tbody.querySelectorAll("tr"));

        rows.forEach(row => {
            const title = row.dataset.title;
            const tags = row.dataset.tags.split(",");
            const matchQuery = title.includes(query);
            const matchTag = !activeTag || tags.includes(activeTag);
            row.style.display = (matchQuery && matchTag) ? "" : "none";
        });

        const visibleRows = rows.filter(row => row.style.display !== "none");

        const activeSort = Object.entries(sortState).find(([_, v]) => v !== null);

        if (activeSort) {
            const [sortKey, sortOrder] = activeSort;

            visibleRows.sort((a, b) => {
                let aVal = a.dataset[sortKey];
                let bVal = b.dataset[sortKey];

                if (sortKey === "year") {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                }

                if (aVal === bVal) return 0;

                if (sortOrder === "asc") {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        visibleRows.forEach(row => tbody.appendChild(row));
        updateSortButtonUI();
    }

    searchInput.addEventListener("input", filterAndSortRows);

    tagButtons.forEach(button => {
        button.addEventListener("click", () => {
            if (activeTag === button.dataset.tag) {
                activeTag = null;
                button.classList.remove("active");
            } else {
                activeTag = button.dataset.tag;
                tagButtons.forEach(btn => btn.classList.toggle("active", btn === button));
            }
            filterAndSortRows();
        });
    });

    sortButtons.forEach(button => {
        button.addEventListener("click", () => {
            const key = button.dataset.sort;
            if (sortState[key] === "asc") {
                sortState = { title: null, year: null };
                sortState[key] = "desc";
            } else {
                sortState = { title: null, year: null };
                sortState[key] = "asc";
            }
            filterAndSortRows();
        });
        button.addEventListener("keydown", e => {
            if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                button.click();
            }
        });
    });

    filterAndSortRows();
</script>
</body>
</html>
